<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMT 股票实时监控系统</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #00adb5;
            --buy-color: #ff4d4d;
            --sell-color: #2ecc71;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #444;
        }

        th {
            color: var(--accent-color);
        }

        .signal-buy {
            color: var(--buy-color);
            font-weight: bold;
        }

        .signal-sell {
            color: var(--sell-color);
            font-weight: bold;
        }

        .signal-container {
            max-height: 400px;
            /* 固定高度 */
            overflow-y: auto;
            /* 内部滚动 */
            border: 1px solid #444;
            border-radius: 4px;
            background: #222;
        }

        /* 隐藏滚动条样式 */
        .signal-container::-webkit-scrollbar {
            width: 8px;
        }

        .signal-container::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .signal-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .signal-container::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        #alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background-color: var(--accent-color);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            animation: slideIn 0.5s ease-out;
            border-left: 5px solid rgba(255, 255, 255, 0.4);
            cursor: pointer;
            /* 增加点击手势 */
            position: relative;
            transition: transform 0.2s, opacity 0.2s;
        }

        .toast:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
        }

        .toast::after {
            content: "×";
            /* 提示可关闭 */
            position: absolute;
            right: 10px;
            top: 5px;
            font-size: 18px;
            opacity: 0.7;
        }

        .config-input {
            background-color: #333;
            border: 1px solid #444;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            width: 50px;
            margin: 0 5px;
            text-align: center;
        }

        /* UI 增强样式 */
        .ui-row {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: stretch;
        }

        .ui-card {
            background: #252526;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            height: 52px;
            flex: 1;
            transition: border-color 0.2s;
        }

        .ui-card:hover {
            border-color: #444;
        }

        .ui-btn {
            height: 32px;
            padding: 0 16px;
            border-radius: 4px;
            border: 1px solid transparent;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .btn-secondary {
            background-color: #3e3e42;
            border-color: #454545;
            color: #ccc;
        }

        .btn-secondary:hover {
            background-color: #454545;
            color: #fff;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #1e8449;
        }

        .ui-input {
            background-color: #1e1e1e;
            border: 1px solid #3c3c3c;
            color: #d4d4d4;
            padding: 4px 8px;
            border-radius: 4px;
            width: 48px;
            margin: 0 8px;
            text-align: center;
            height: 24px;
            outline: none;
            transition: border-color 0.2s;
        }

        .status-label {
            color: #888;
            margin-right: 8px;
            font-size: 0.9em;
        }

        .status-value {
            font-weight: 600;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>QMT 股票实时监控系统</h1>
            <div style="text-align: right;">
                <div id="status">连接中...</div>
                <div id="last-scan" style="font-size: 0.8em; color: #888;">上次扫描: -</div>
            </div>
        </header>

        <div class="dashboard">
            <div class="card">
                <h2>监控管理</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="stock-input" placeholder="输入代码(如 600000) 或 名称(如 浦发银行)"
                        style="padding: 12px; flex: 1; border-radius: 4px; border: 1px solid #444; background: #333; color: white; font-size: 16px;">
                    <button onclick="addStock()" class="ui-btn btn-success"
                        style="height: 48px; border-radius: 4px; padding: 0 30px;">添加监控</button>
                </div>
                <div class="ui-row">
                    <!-- 左侧：系统状态 -->
                    <div class="ui-card" style="justify-content: space-between;">
                        <div style="display: flex; gap: 30px;">
                            <div>
                                <span class="status-label">系统状态</span>
                                <span id="sys-status" class="status-value">就绪</span>
                            </div>
                            <div>
                                <span class="status-label">监控总数</span>
                                <span id="sys-count" class="status-value">0</span>
                            </div>
                        </div>
                        <button id="btn-toggle-monitor" class="ui-btn" onclick="toggleMonitor()">启动监控</button>
                    </div>

                    <!-- 右侧：全局配置 -->
                    <div class="ui-card" style="justify-content: space-between;">
                        <div style="display: flex; align-items: center;">
                            <span class="status-label">扫描间隔</span>
                            <input type="number" id="scan-interval" class="ui-input" min="1" max="3600"
                                placeholder="..">
                            <span style="color: #666; font-size: 0.8em;">秒</span>
                        </div>
                        <button class="ui-btn btn-secondary" onclick="saveConfig()">保存设置</button>
                    </div>
                </div>
                <h3>当前监控列表</h3>
                <table id="stock-table">
                    <thead>
                        <tr>
                            <th>代码</th>
                            <th>名称</th>
                            <th>现价</th>
                            <th>涨跌幅</th>
                            <th>添加时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 股票列表 -->
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>实时预警信号</h2>
                <div class="signal-container">
                    <table id="signal-table">
                        <thead>
                            <tr style="position: sticky; top: 0; background: var(--card-bg); z-index: 10;">
                                <th>时间</th>
                                <th>股票</th>
                                <th>周期</th>
                                <th>信号类型</th>
                                <th>价格</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 信号将通过 JS 动态插入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="alert-toast"></div>

    <audio id="alert-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"></audio>

    <script>
        const signalTable = document.getElementById('signal-table').getElementsByTagName('tbody')[0];
        const stockTable = document.getElementById('stock-table').getElementsByTagName('tbody')[0];
        const statusDiv = document.getElementById('status');
        const lastScanDiv = document.getElementById('last-scan');
        const sysStatusSpan = document.getElementById('sys-status');
        const sysCountSpan = document.getElementById('sys-count');
        const alertToast = document.getElementById('alert-toast');
        const alertSound = document.getElementById('alert-sound');

        // 初始化加载
        loadStocks();
        loadSignals();
        // 强制首次同步状态，确保 interval 被填入
        updateSystemStatus(true);

        setInterval(() => updateSystemStatus(), 5000); // 每5秒更新一次状态
        setInterval(loadStocks, 5000); // 每5秒刷新一次行情

        let ws;
        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/ws/alerts`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusDiv.innerText = '实时连接: 已开启';
                statusDiv.style.color = '#2ecc71';
                console.log('WebSocket connected');
            };

            ws.onclose = () => {
                statusDiv.innerText = '实时连接: 已断开 (正在尝试重连...)';
                statusDiv.style.color = '#ff4d4d';
                console.log('WebSocket disconnected. Reconnecting in 3 seconds...');
                setTimeout(connectWebSocket, 3000); // 3秒后尝试重连
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
                ws.close();
            };

            ws.onmessage = (event) => {
                const alert = JSON.parse(event.data);
                const isBuy = addSignalToTable(alert); // 修改 addSignalToTable 返回是否看涨
                showToast(alert, isBuy);
                alertSound.play();
            };
        }

        // 初始化连接
        connectWebSocket();

        async function updateSystemStatus(isInitial = false) {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                const isRunning = data.status === 'Running';

                // 只有在没被选中，或者初始化时才更新显示值
                const intervalInput = document.getElementById('scan-interval');
                if (isInitial || document.activeElement !== intervalInput) {
                    intervalInput.value = data.interval;
                }

                sysStatusSpan.innerText = isRunning ? '正在监控' : '已停止';
                sysStatusSpan.style.color = isRunning ? '#2ecc71' : '#ff4d4d';
                lastScanDiv.innerText = `上次扫描: ${data.last_scan_time || '-'}`;
                sysCountSpan.innerText = data.stock_count;

                // 更新按钮状态与颜色
                const btn = document.getElementById('btn-toggle-monitor');
                if (isRunning) {
                    btn.innerText = '停止监控';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-danger');
                } else {
                    btn.innerText = '启动监控';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-success');
                }
            } catch (e) {
                console.error("Failed to update status", e);
            }
        }

        // 调用初始化状态获取
        updateSystemStatus(true);

        async function toggleMonitor() {
            const btn = document.getElementById('btn-toggle-monitor');
            const isRunning = btn.innerText === '停止监控';
            const action = isRunning ? 'stop' : 'start';

            try {
                const res = await fetch(`/api/monitor/${action}`, { method: 'POST' });
                if (res.ok) {
                    updateSystemStatus();
                    showToast({ stock_code: '系统', timeframe: '全局', signal_type: isRunning ? '监控已计划停止' : '监控已计划启动' }, !isRunning);
                }
            } catch (e) {
                alert('操作失败: ' + e);
            }
        }

        async function saveConfig() {
            const intervalInput = document.getElementById('scan-interval');
            const interval = parseInt(intervalInput.value);
            if (isNaN(interval) || interval < 1) {
                alert('请输入有效的扫描间隔（大于0）');
                return;
            }

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interval: interval })
                });

                if (response.ok) {
                    alert('配置已成功保存！');
                    const statusRes = await fetch('/api/status');
                    const statusData = await statusRes.json();
                    const isRunning = statusData.status === 'Running';

                    if (isRunning) {
                        if (confirm('是否立即重启监控以应用新间隔？')) {
                            await fetch('/api/monitor/stop', { method: 'POST' });
                            setTimeout(async () => {
                                await fetch('/api/monitor/start', { method: 'POST' });
                                showToast({ stock_code: '系统', timeframe: '全局', signal_type: '监控已重启并应用新配置' }, true);
                                updateSystemStatus(true);
                            }, 500);
                        }
                    } else {
                        showToast({ stock_code: '系统', timeframe: '全局', signal_type: '扫描间隔已设定，下次启动生效' }, true);
                    }
                }
            } catch (error) {
                console.error('Save config error:', error);
                alert('保存配置失败');
            }
        }

        async function loadStocks() {
            try {
                const res = await fetch('/api/stocks');
                const stocks = await res.json();
                stockTable.innerHTML = '';
                stocks.forEach(stock => {
                    const row = stockTable.insertRow();
                    const changeColor = stock.change_pct > 0 ? '#ff4d4d' : (stock.change_pct < 0 ? '#2ecc71' : '#e0e0e0');
                    row.innerHTML = `
                        <td>${stock.code}</td>
                        <td>${stock.name || '-'}</td>
                        <td style="color: ${changeColor}; font-weight: bold;">${stock.price.toFixed(2)}</td>
                        <td style="color: ${changeColor}; font-weight: bold;">${stock.change_pct > 0 ? '+' : ''}${stock.change_pct.toFixed(2)}%</td>
                        <td>${stock.added_at}</td>
                        <td><button onclick="deleteStock('${stock.code}')" class="ui-btn btn-secondary" style="height: 24px; padding: 0 8px; font-size: 11px; border-color: rgba(231, 76, 60, 0.3); color: #e74c3c;">删除</button></td>
                    `;
                });
            } catch (e) {
                console.error("Failed to load stocks", e);
            }
        }

        async function loadSignals() {
            const res = await fetch('/api/signals');
            const signals = await res.json();
            signalTable.innerHTML = '';
            signals.forEach(addSignalToTable);
        }

        async function addStock() {
            const input = document.getElementById('stock-input');
            const code = input.value.trim();
            if (!code) return alert('请输入股票代码或名称');

            const res = await fetch('/api/stocks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });
            const result = await res.json();
            if (result.status === 'success') {
                input.value = '';
                loadStocks();
                showToast({ stock_code: result.data.code, timeframe: '系统', signal_type: '添加成功' });
            } else {
                alert('添加失败: ' + result.message);
            }
        }

        async function deleteStock(code) {
            if (!confirm(`确定删除 ${code} 吗？`)) return;
            const res = await fetch(`/api/stocks/${code}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.status === 'success') {
                loadStocks();
            }
        }

        function addSignalToTable(alert) {
            const row = signalTable.insertRow(0);
            const stockCode = alert.stock_code || alert.code;
            const stockName = alert.name || '';
            const displayName = stockName ? `${stockName} (${stockCode})` : stockCode;

            // 信号名称字典 (转换历史英文信号)
            const signalMap = {
                'DIV_BULL': 'MACD底背离',
                'DIV_BEAR': 'MACD顶背离',
                'TD9_BUY': 'TD低9',
                'TD9_SELL': 'TD高9'
            };

            let signalType = alert.signal_type;
            // 只要匹配字典，就强制转换
            if (signalMap[signalType]) {
                signalType = signalMap[signalType];
            }

            // 颜色逻辑：低/底 -> 红色 (signal-buy), 高/顶 -> 绿色 (signal-sell)
            // 匹配中文关键词以确保颜色准确
            const isBuy = signalType.includes('低') || signalType.includes('底') || signalType.includes('BULL') || signalType.includes('BUY');
            const signalClass = isBuy ? 'signal-buy' : 'signal-sell';

            row.innerHTML = `
                <td>${alert.timestamp || alert.added_at}</td>
                <td>${displayName}</td>
                <td>${alert.timeframe}</td>
                <td class="${signalClass}">
                    ${signalType}
                </td>
                <td>${alert.price}</td>
            `;

            // 更新该警报的对象属性，确保 toast 使用正确的中文
            alert.display_signal = signalType;
            return isBuy;
        }

        function showToast(alert, isBuy) {
            const toast = document.createElement('div');
            toast.className = 'toast';

            // 根据买卖信号设置气泡背景色
            if (isBuy !== undefined) {
                toast.style.backgroundColor = isBuy ? '#d32f2f' : '#27ae60';
            }

            const signal = alert.display_signal || alert.signal_type;
            toast.innerHTML = `
                <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 5px;">新信号提醒</div>
                <div>${alert.name || alert.stock_code} (${alert.timeframe}) - ${signal}</div>
                <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.8; text-align: right;">点击关闭</div>
            `;

            // 手动点击关闭
            toast.onclick = () => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 200);
            };

            alertToast.appendChild(toast);
            // 不再使用 setTimeout 自动删除
        }
    </script>
</body>

</html>